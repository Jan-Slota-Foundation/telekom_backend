from flask import Flask, jsonify, request
from flask_cors import CORS
import csv
from pathlib import Path
import os

app = Flask(__name__)
CORS(app)  # Enable CORS for all routes

stored = []

@app.route('/')
def home():
    return jsonify({
        "message": "Welcome to the Flask Server",
        "status": "running"
    })

@app.route('/analyze', methods=["GET", "POST"])
def analyze():
    if request.method == "POST":
        data = request.get_json()
        if not data or not isinstance(data, dict):
            return jsonify({
                "error": "invalid data format",
                "message": "Please provide valid JSON data",
            }), 400
        
        # Clear the stored list before adding new data
        stored.clear()
        stored.append(data)
        csv_string = stored[0]["content"]

        # Define the output file path
        output_file = "output.csv"

        try:
            # Write the content to the file
            # Using 'w' mode automatically overwrites the existing content
            with open(output_file, "w", encoding='utf-8') as file:
                file.write(csv_string)

            return jsonify({
                "message": "data received successfully",
                "saved_data": data,
                "total_items": len(data),
                "file_path": output_file
            })

        except Exception as e:
            return jsonify({
                "error": "file write error",
                "message": str(e)
            }), 500

@app.route('/health')
def health_check():
    return jsonify({
        "status": "healthy",
        "server": "running"
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=3000, debug=True)